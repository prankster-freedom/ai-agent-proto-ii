@startuml
title チャットシーケンス

actor "ユーザー" as User
participant "フロントエンド" as Frontend
participant "Cloud Functions\n(onCall)" as Functions
participant "Gemini API" as Gemini
participant "Firestore" as Firestore

activate User
User -> Frontend: メッセージを入力し送信
activate Frontend

Frontend -> Firestore: チャット履歴を保存
activate Firestore
Firestore --> Frontend: 保存完了
deactivate Firestore

Frontend -> Functions: チャットメッセージを送信
activate Functions

Functions -> Firestore: 直近の対話履歴とAIの性格設定を取得
activate Firestore
Firestore --> Functions: 履歴と性格設定
deactivate Firestore

Functions -> Gemini: 履歴、性格設定、ユーザーメッセージを基に\n応答生成をリクエスト
activate Gemini
Gemini --> Functions: AIの応答
deactivate Gemini

Functions --> Frontend: AIの応答を返す
deactivate Functions

Frontend -> Firestore: AIの応答を履歴に保存
activate Firestore
Firestore --> Frontend: 保存完了
deactivate Firestore

Frontend -> User: AIの応答を表示
deactivate Frontend

deactivate User

@enduml
