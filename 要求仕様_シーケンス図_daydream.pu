@startuml
title daydreamシーケンス (FR1-2)

participant "フロントエンド" as Frontend
participant "Cloud Functions\n(onCall)" as Functions
participant "Gemini API" as Gemini
participant "Firestore" as Firestore

activate Frontend
Frontend -> Functions: チャットメッセージを送信
note left: 対話回数が10の倍数に達した

activate Functions
Functions -> Functions: daydream処理を非同期で実行

activate Functions #LightBlue
Functions -> Firestore: 直近10回分の対話履歴を取得
activate Firestore
Firestore --> Functions: 対話履歴
deactivate Firestore

Functions -> Gemini: 対話履歴を渡し、性格特性の抽出をリクエスト
activate Gemini
note right of Gemini
Big Fiveなどの心理学モデルに基づき
ユーザーの性格特性を抽出
end note
Gemini --> Functions: 性格特性データ
deactivate Gemini

Functions -> Firestore: 抽出した性格特性を分析日時と共に保存
activate Firestore
Firestore --> Functions: 保存完了
deactivate Firestore

deactivate Functions
deactivate Functions #LightBlue

@enduml
