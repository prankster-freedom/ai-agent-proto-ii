@startuml
title dreamシーケンス (FR1-2)

actor "Cloud Scheduler" as Scheduler
participant "Cloud Functions\n(onRun)" as Functions
participant "Firestore" as Firestore
participant "Gemini API" as Gemini

Scheduler -> Functions: 毎日深夜0時(UTC)に起動
activate Functions

Functions -> Firestore: その日にアクティビティのあった\n全ユーザーのIDを取得
activate Firestore
Firestore --> Functions: ユーザーIDリスト
deactivate Firestore

loop 各ユーザー
  Functions -> Firestore: 当該ユーザーのその日の対話履歴と\n過去の性格分析結果を取得
  activate Firestore
  Firestore --> Functions: 対話履歴と性格分析結果
  deactivate Firestore

  Functions -> Gemini: 履歴と分析結果を渡し、\n性格の統合・要約をリクエスト
  activate Gemini
  Gemini --> Functions: 要約されたAIのベース性格設定
  deactivate Gemini

  Functions -> Firestore: 新しいAIのベース性格設定を保存
  activate Firestore
  Firestore --> Functions: 保存完了
  deactivate Firestore
end

deactivate Functions

@enduml
